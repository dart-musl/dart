From a38e3bb735d8be94bd7c8be1513526aba7796552 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E3=81=AA=E3=81=A4=E3=81=8D?= <i@ntk.me>
Date: Sun, 15 Jan 2023 17:55:20 -0800
Subject: [PATCH 1/6] compiler-target

---
 build/config/compiler/BUILD.gn                | 20 +++++++++----------
 build/rust/rust.gni                           |  2 +-
 .../tests/vm/dart/use_flag_test_helper.dart   |  4 ++--
 .../tests/vm/dart_2/use_flag_test_helper.dart |  4 ++--
 4 files changed, 15 insertions(+), 15 deletions(-)

diff --git a/build/config/compiler/BUILD.gn b/build/config/compiler/BUILD.gn
index f2984fb8..a593b59f 100644
--- a/build/config/compiler/BUILD.gn
+++ b/build/config/compiler/BUILD.gn
@@ -265,20 +265,20 @@ config("compiler") {
   if (is_linux) {
     if (is_clang) {
       if (current_cpu == "arm") {
-        cflags += [ "--target=armv7-linux-gnueabihf" ]
-        ldflags += [ "--target=armv7-linux-gnueabihf" ]
+        cflags += [ "--target=armv7-alpine-linux-musleabihf" ]
+        ldflags += [ "--target=armv7-alpine-linux-musleabihf" ]
       } else if (current_cpu == "arm64") {
-        cflags += [ "--target=aarch64-linux-gnu" ]
-        ldflags += [ "--target=aarch64-linux-gnu" ]
+        cflags += [ "--target=aarch64-alpine-linux-musl" ]
+        ldflags += [ "--target=aarch64-alpine-linux-musl" ]
       } else if (current_cpu == "riscv32") {
-        cflags += [ "--target=riscv32-linux-gnu" ]
-        ldflags += [ "--target=riscv32-linux-gnu" ]
+        cflags += [ "--target=riscv32-alpine-linux-musl" ]
+        ldflags += [ "--target=riscv32-alpine-linux-musl" ]
       } else if (current_cpu == "riscv64") {
-        cflags += [ "--target=riscv64-linux-gnu" ]
-        ldflags += [ "--target=riscv64-linux-gnu" ]
+        cflags += [ "--target=riscv64-alpine-linux-musl" ]
+        ldflags += [ "--target=riscv64-alpine-linux-musl" ]
       } else if (current_cpu == "x86") {
-        cflags += [ "--target=i386-linux-gnu" ]
-        ldflags += [ "--target=i386-linux-gnu" ]
+        cflags += [ "--target=i586-alpine-linux-musl" ]
+        ldflags += [ "--target=i586-alpine-linux-musl" ]
       }
     }
   }
diff --git a/build/rust/rust.gni b/build/rust/rust.gni
index 0a8cdc13..ed6cb449 100644
--- a/build/rust/rust.gni
+++ b/build/rust/rust.gni
@@ -26,7 +26,7 @@ template("rust_library") {
   # of the targets that rust supports like this: rustc --print target-list
   cargo_out_dir = target_out_dir
   if (is_linux) {
-    rust_os = "unknown-linux-gnu"
+    rust_os = "unknown-linux-musl"
   } else if (is_mac) {
     rust_os = "apple-darwin"
   } else if (is_win) {
diff --git a/runtime/tests/vm/dart/use_flag_test_helper.dart b/runtime/tests/vm/dart/use_flag_test_helper.dart
index 431fce51..311c655f 100644
--- a/runtime/tests/vm/dart/use_flag_test_helper.dart
+++ b/runtime/tests/vm/dart/use_flag_test_helper.dart
@@ -65,9 +65,9 @@ Future<void> assembleSnapshot(String assemblyPath, String snapshotPath) async {
     // Tell Mac linker to give up generating eh_frame from dwarf.
     ldFlags.add('-Wl,-no_compact_unwind');
   } else if (buildDir.endsWith('SIMARM')) {
-    ccFlags.add('--target=armv7-linux-gnueabihf');
+    ccFlags.add('--target=armv7-alpine-linux-musleabihf');
   } else if (buildDir.endsWith('SIMARM64')) {
-    ccFlags.add('--target=aarch64-linux-gnu');
+    ccFlags.add('--target=aarch64-alpine-linux-musl');
   }
 
   if (buildDir.endsWith('X64') || buildDir.endsWith('SIMARM64')) {
diff --git a/runtime/tests/vm/dart_2/use_flag_test_helper.dart b/runtime/tests/vm/dart_2/use_flag_test_helper.dart
index b408f42a..5953bb76 100644
--- a/runtime/tests/vm/dart_2/use_flag_test_helper.dart
+++ b/runtime/tests/vm/dart_2/use_flag_test_helper.dart
@@ -66,9 +66,9 @@ Future<void> assembleSnapshot(String assemblyPath, String snapshotPath) async {
     // Tell Mac linker to give up generating eh_frame from dwarf.
     ldFlags.add('-Wl,-no_compact_unwind');
   } else if (buildDir.endsWith('SIMARM')) {
-    ccFlags.add('--target=armv7-linux-gnueabihf');
+    ccFlags.add('--target=armv7-alpine-linux-musleabihf');
   } else if (buildDir.endsWith('SIMARM64')) {
-    ccFlags.add('--target=aarch64-linux-gnu');
+    ccFlags.add('--target=aarch64-alpine-linux-musl');
   }
 
   if (buildDir.endsWith('X64') || buildDir.endsWith('SIMARM64')) {
-- 
2.39.0

